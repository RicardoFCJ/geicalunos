prog=as.data.table(read_xlsx(path))
path="programas2/143-Módulo1_VERSÃO 2.xlsx"
prog=as.data.table(read_xlsx(path))
prog
path
prog=as.data.table(read_xlsx(path,2))
prog
aba=ifelse(grepl("Módulo1",path),2,1)
aba
prog[,c(1,2,3,5)]
as.data.table(dbReadTable("TENTATIVAOCORRENCIA"))
as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
prog
prog=prog[,c(1,2,3,5)]
prog
prog=as.data.table(read_xlsx(path,aba))
prog=prog[,c(1,2,3,5)][Default==1]
prog
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
tentOco
prog[,Oco:=0]
for (tt in 1:dim(prog)[1]){
prog[tt,Oco:=tentOco[TENTATIVA_ID==NOME&BLOCO_ID==Bloco,ID]]
}
prog[,Oco:=0]
for (tt in 1:dim(prog)[1]){
prog[tt,Oco:=tentOco[TENTATIVA_ID==NOME&BLOCO_ID==BLOCO,ID]]
}
tt
tentOco[TENTATIVA_ID==prog$NOME[1]&BLOCO_ID==prog$BLOCO[1],ID]
prog
prog[1]
tentOco[TENTATIVA_ID==6413]
tentOco[TENTATIVA_ID==6413&BLOCO_ID==1109]
prog[,Oco:=0]
for (tt in 1:dim(prog)[1]){
prog[tt,Oco:=tentOco[TENTATIVA_ID==prog$NOME[tt]&BLOCO_ID==prog$BLOCO[tt],ID]]
}
tt
tentOco[TENTATIVA_ID==prog$NOME[tt]&BLOCO_ID==prog$BLOCO[tt],ID]
str(prog)
str(tentOco)
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
str(tentOco)
for (tt in 1:dim(prog)[1]){
prog[tt,Oco:=tentOco[TENTATIVA_ID==prog$NOME[tt]&BLOCO_ID==prog$BLOCO[tt],ID]]
}
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
?set
prog[,Oco:=0]
for (tt in 1:dim(prog)[1]){
set(prog,tt,"Oco",tentOco[TENTATIVA_ID==prog$NOME[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog$NOME[tt]
prog[,Oco:=0]
for (tt in 1:dim(prog)[1]){
set(prog,tt,"Oco",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
tent
prog
al=takeit.byalunoSQL(6487)
al
al
al = al[PROGRAMA==143&CANCELADA==0&NROINTERACAO==1]
al
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
grepl("TENTATIVA",colnames(prog))
prog=prog[,c(1,2,3,5)][Default==1]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
prog[,ID:=0]
for (tt in 1:dim(prog)[1]){
set(prog,tt,"ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog
passoOco=prog
alt=200;larg=100
par(mar=c(0,0,0,0))
graphmax=prog[,uniqueN(NOME)]*22+25
plot(c(-75,1275),c(-75,graphmax),ann=F,xaxt='n',yaxt='n',bty='n',col='white')
x=0;y=graphmax-25
plts=0
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
if(grepl("Módulo1",path)){
bgcol=ifelse(al[,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n,uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}else{
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
i
grepl("Módulo1",path)
bgcol=ifelse(al[,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n,uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
reps
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
if(grepl("Módulo1",path)){
bgcol=ifelse(al[,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n,uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}else{
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
runApp()
al = takeit.byalunoSQL(7795)
al=al[PROGRAMA==143&CANCELADA==0]
al
al=al[NROINTERACAO==1]
al
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
prog
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
prog=prog[,c(1,2,3,5)][Default==1]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
prog[,ID:=0]
for (tt in 1:dim(prog)[1]){
set(prog,tt,"ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog
passoOco=prog
alt=200;larg=100
par(mar=c(0,0,0,0))
graphmax=prog[,uniqueN(NOME)]*22+25
plot(c(-75,1275),c(-75,graphmax),ann=F,xaxt='n',yaxt='n',bty='n',col='white')
x=0;y=graphmax-25
plts=0
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.nome
passoOco
str(passoOco)
str(as.data.table(read_xlsx(path,aba)))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
passoOco=prog
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.nome
prog
cur.nome
prog
prog[,unique(NOME)]
i
i=1
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
if(grepl("Módulo1",path)){
bgcol=ifelse(al[,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n,uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}else{
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
drawProg=function(path,al,Change="Default"){
programa=unlist(strsplit(path,"-"))[[1]][1]%>%{gsub("[^0-9]","",.)}%>%as.numeric
passoOco=getTentOco(path)
alt=200;larg=100
par(mar=c(0,0,0,0))
graphmax=prog[,uniqueN(NOME)]*22+25
plot(c(-75,1275),c(-75,graphmax),ann=F,xaxt='n',yaxt='n',bty='n',col='white')
x=0;y=graphmax-25
plts=0
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
if(grepl("Módulo1",path)){
bgcol=ifelse(al[,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n,uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}else{
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
}
runApp()
al
tentOco[TENTATIVA_ID==6511]
tentOco[TENTATIVA_ID==6511&BLOCO_ID==1133]
al[OCORRENCIA_ID==50473]
al[OCORRENCIA_ID==50473,uniqueN(ID),by=ID]
al[OCORRENCIA_ID==50473,uniqueN(ID)]
runApp()
tentOco[TENTATIVA_ID==5399&BLOCO_ID==871]
al[OCORRENCIA_ID==42204]
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[PASSO_ID%in%c(177784,177598)]
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[ID%in%c(177784,177598)]
tentOco
as.data.table(dbReadTable(sql,"BLOCOOCORRENCIA"))
prog=as.data.table(read_xlsx(path,aba))
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
prog
path
dput(path)
path="programas/143-Módulo1_VERSÃO 2.xlsx"
prog=as.data.table(read_xlsx(path,aba))
prog
path="programas/143-Módulo1_.xlsx"
path
as.data.table(read_xlsx(path,aba))
path="programas/143-Módulo1.xlsx"
as.data.table(read_xlsx(path,aba))
path="programas2/143-Módulo1_VERSÃO 2.xlsx"
as.data.table(read_xlsx(path,aba))
as.data.table(read_xlsx(path,aba,2))
as.data.table(read_xlsx(path,aba))
path="programas2/143-Módulo1.xlsx"
as.data.table(read_xlsx(path,aba))
path="programas/143-Módulo1.xlsx"
as.data.table(read_xlsx(path,aba))
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
passoOco
prog[,PASSOOCO:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog
runApp()
runApp()
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
prog[,PASSOOCO:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
grepl("TENTATIVA",colnames(prog))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
prog[,ID:=0]
for (tt in 1:dim(prog)[1]){
set(prog,tt,"ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog
which(!is.na(prog$TENTATIVA))
for (tt in which(!is.na(prog$TENTATIVA))){
set(prog,tt,"ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog
runApp()
runApp()
runApp()
al[,unique(PROGRAMA)]
i=1
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
prog
passoOco=prog
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.nome
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco
prog
alt=200;larg=100
par(mar=c(0,0,0,0))
graphmax=prog[,uniqueN(NOME)]*22+25
plot(c(-75,1275),c(-75,graphmax),ann=F,xaxt='n',yaxt='n',bty='n',col='white')
x=0;y=graphmax-25
plts=0
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
if(grepl("Módulo1",path)){
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSOOCO_ID)]
bgcol=ifelse(al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n&PASSOOCO_ID%in%cur.passos,uniqueN(ID)]
}else{
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
passoOco
cur.nome=passoOco[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.oco
passoOco[,PASSOOCO_ID:=PASSOOCO]
cur.oco=passoOco[NOME%in%levels(NOME)[i],unique(ID)]
cur.oco
cur.oco.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(ID)]
cur.oco.n
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSOOCO_ID)]
bgcol=ifelse(al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n&PASSOOCO_ID%in%cur.passos,uniqueN(ID)]
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)]
runApp()
path
prog=getTentOco(path)
prog
getTentOco = function(path){
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
prog[,PASSOOCO_ID:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog[,TENTATIVAOCO_ID:=0]
for (tt in which(!is.na(prog$TENTATIVA))){
set(prog,tt,"TENTATIVAOCO_ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
return(prog)
}
prog=getTentOco(path)
prog
getTentOco = function(path){
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
prog[,PASSOOCO_ID:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog[,TENTATIVAOCO_ID:=0]
for (tt in which(!is.na(prog$TENTATIVA))){
set(prog,tt,"TENTATIVAOCO_ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog[TENTATIVAOCO_ID==0,TENTATIVAOCO_ID:=NA]
return(prog)
}
prog=getTentOco(path)
prog
prog
cur.nome=prog[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.oco
cur.oco.n=prog[NOME%in%levels(NOME)[i]&WHERE==1,unique(TENTATIVAOCO_ID)]
cur.oco.n
cur.oco.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(TENTATIVAOCO_ID)]
cur.oco.n
cur.oco
cur.nome
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos
cur.passos=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(PASSOOCO_ID)]
cur.passos.n
cur.passos
al[PASSOOCO_ID%in%cur.passos,]
cur.passsos
cur.passos
al
i
prog
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[PASSO==368]
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[PASSO_ID==368]
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[PASSO_ID==368&PROGRAMA==143]
as.data.table(dbReadTable(sql,"PASSOOCORRENCIA"))[PASSO_ID==368&PROGRAMA_ID==143]
prog
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),')')))
prog[,PASSOOCO_ID:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog
match(prog$PASSO[1],passoOco$PASSO_ID[1])
prog$PASSO
prog$PASSO[1]
passoOco
passoOco[PASSO_ID==368]
passoOco[match(prog$PASSO,PASSO_ID),ID]
path
programa=143
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),') AND PROGRAMA_ID = ',programa)))
prog[,PASSOOCO_ID:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog[,TENTATIVAOCO_ID:=0]
for (tt in which(!is.na(prog$TENTATIVA))){
set(prog,tt,"TENTATIVAOCO_ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog
prog[TENTATIVAOCO_ID==0,TENTATIVAOCO_ID:=NA]
alt=200;larg=100
par(mar=c(0,0,0,0))
graphmax=prog[,uniqueN(NOME)]*22+25
plot(c(-75,1275),c(-75,graphmax),ann=F,xaxt='n',yaxt='n',bty='n',col='white')
x=0;y=graphmax-25
plts=0
for(i in 1:prog[,uniqueN(NOME)]){
cur.nome=prog[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.oco.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(TENTATIVAOCO_ID)]
if(grepl("Módulo1",path)){
cur.passos=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(PASSOOCO_ID)]
bgcol=ifelse(al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)],'lightgreen','white')
reps=al[OCORRENCIA_ID%in%cur.oco.n&PASSOOCO_ID%in%cur.passos,uniqueN(ID)]
}else{
cur.passos=passoOco[NOME%in%levels(NOME)[i],unique(PASSO_ID)]
cur.passos.n=passoOco[NOME%in%levels(NOME)[i]&WHERE==1,unique(PASSO_ID)]
bgcol=ifelse(al[,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
reps=al[PASSOOCO_ID%in%cur.oco.n&OCORRENCIA_ID%in%passoOco[PASSO_ID%in%cur.passos.n,TentIni],uniqueN(ID),by=PASSOOCO_ID][,ifelse(.N>0,max(V1),0)]
}
symbols(x,y,rectangles = matrix(c(alt,larg),ncol=2),add = T,inches=F,bg=bgcol)
text(x,y,labels=paste0(cur.nome,' (',reps,')'),cex=.7)
plts=plts+1
if(plts==7){plts=0;x=0;y=y-150}else{
x=x+200
}
}
prog=getTentOco(path,programa)
getTentOco = function(path,programa){
aba=ifelse(grepl("Módulo1",path),2,1)
prog=as.data.table(read_xlsx(path,aba))
prog[,NOME:=factor(NOME,levels=unique(NOME))]
colnames(prog)[colnames(prog)=="Default"]="WHERE"
tentOco=as.data.table(dbReadTable(sql,"TENTATIVAOCORRENCIA"))
passos=prog[,PASSO]
passoOco = as.data.table(dbGetQuery(sql,paste0('select * from PASSOOCORRENCIA where PASSO_ID in (',paste(passos,collapse=', '),') AND PROGRAMA_ID = ',programa)))
prog[,PASSOOCO_ID:=passoOco[match(prog$PASSO,PASSO_ID),ID]]
prog[,TENTATIVAOCO_ID:=0]
for (tt in which(!is.na(prog$TENTATIVA))){
set(prog,tt,"TENTATIVAOCO_ID",tentOco[TENTATIVA_ID==prog$TENTATIVA[tt]&BLOCO_ID==prog$BLOCO[tt],ID])
}
prog[TENTATIVAOCO_ID==0,TENTATIVAOCO_ID:=NA]
return(prog)
}
prog=getTentOco(path,programa)
prog
prog
i=1
al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)]
al[PASSOOCO_ID%in%cur.passos,]
cur.nome=prog[NOME%in%levels(NOME)[i],unique(NOME)]
cur.oco=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.oco.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(TENTATIVAOCO_ID)]
cur.passos=prog[NOME%in%levels(NOME)[i],unique(PASSOOCO_ID)]
cur.passos.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(PASSOOCO_ID)]
al[PASSOOCO_ID%in%cur.passos,]
al[PASSOOCO_ID%in%cur.passos,any(OCORRENCIA_ID%in%cur.oco)]
cur.oco
bgcol=ifelse(al[PASSOOCO_ID%in%cur.passos,any(PASSOOCO_ID%in%cur.oco)],'lightgreen','white')
bgcol
cur.oco.n=prog[NOME%in%levels(NOME)[i]&!is.na(TENTATIVAOCO_ID),unique(TENTATIVAOCO_ID)]
cur.oco.n
reps=al[OCORRENCIA_ID%in%cur.oco.n&PASSOOCO_ID%in%cur.passos,uniqueN(ID)]
reps
cur.passos
runApp()
al
prog
prog[NOME=="ENSINO6"]
al[OCORRENCIA_ID==59751&PASSOOCO_ID==177613]
tentOco[PASSO_ID==400&PROGRAMAID==143]
tentOco[PASSO_ID==400&PROGRAMA_ID==143]
passoOco[PASSO_ID==400&PROGRAMA_ID==143]
runApp()
